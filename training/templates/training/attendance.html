{% extends 'base.html' %}
{% block content %}

<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    .attendance-container {
        background: white;
        max-width: 400px;
        margin: 40px auto;
        padding: 30px 25px;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        text-align: center;
    }
    h2 {
        margin-bottom: 25px;
        color: #333;
        font-weight: 700;
    }
    .btn {
        padding: 12px 28px;
        margin: 10px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
    }
    .btn-login { background-color: #4CAF50; }
    .btn-login:hover { background-color: #45a049; transform: translateY(-2px); }
    .btn-logout { background-color: #f44336; }
    .btn-logout:hover { background-color: #e53935; transform: translateY(-2px); }
    .btn-disabled { 
        background-color: #6c757d !important; 
        cursor: not-allowed !important;
    }
    .btn-disabled:hover {
        transform: none !important;
    }

    #output {
        margin-top: 20px;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .badge {
        padding: 12px 15px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .login-badge { background-color: #4CAF50; }
    .logout-badge { background-color: #f44336; }
    .error-badge { background-color: #ff9800; }
    .info-badge { background-color: #17a2b8; }
    
    .user-info {
        margin-bottom: 20px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        font-weight: bold;
    }

    @media (max-width: 450px) {
        .attendance-container { width: 90%; padding: 20px; }
    }
</style>

<div class="attendance-container">
    <div class="user-info">
        Welcome, {{ user.username }}
    </div>
    <h2>Daily Attendance</h2>
    
    <!-- ✅ Show status if already logged in -->
    {% if already_logged_in %}
    <div class="info-badge badge mb-3">
        ✅ You are already logged in today at {{ login_time }}
    </div>
    {% endif %}
    
    <button class="btn btn-login" id="loginBtn" onclick="login()" {% if already_logged_in %}disabled style="display:none;"{% endif %}>
        Login
    </button>
    <button class="btn btn-logout" id="logoutBtn" onclick="logout()" {% if not already_logged_in %}disabled style="display:none;"{% endif %}>
        Logout
    </button>
    
    <div id="output">
        {% if already_logged_in %}
        <div class="info-badge badge">
            Your login was recorded at {{ login_time }}<br>
            Click "Logout" when your work ends.
        </div>
        {% else %}
        Your login/logout info will appear here
        {% endif %}
    </div>
</div>

<script>
// ✅ Track login state
let isLoggedIn = {% if already_logged_in %}true{% else %}false{% endif %};

function updateButtons() {
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (isLoggedIn) {
        loginBtn.style.display = 'none';
        loginBtn.disabled = true;
        logoutBtn.style.display = 'inline-block';
        logoutBtn.disabled = false;
    } else {
        loginBtn.style.display = 'inline-block';
        loginBtn.disabled = false;
        logoutBtn.style.display = 'none';
        logoutBtn.disabled = true;
    }
}

function getLocation(callback) {
    if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser");
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
                const address = data.display_name || `Lat: ${lat}, Lon: ${lon}`;
                callback(lat, lon, address);
            })
            .catch(() => {
                callback(lat, lon, `Lat: ${lat}, Lon: ${lon}`);
            });
        },
        (error) => {
            alert("Location permission denied or error getting location: " + error.message);
        }
    );
}

// ✅ TIME FIXED: Returns Indian Standard Time (IST)
function getCurrentIndianTimeString() {
    const now = new Date();
    
    // Convert to IST (UTC+5:30)
    const istOffset = 5.5 * 60 * 60 * 1000; // 5.5 hours in milliseconds
    const istTime = new Date(now.getTime() + istOffset);
    
    const yyyy = istTime.getUTCFullYear();
    const mm = String(istTime.getUTCMonth() + 1).padStart(2, '0');
    const dd = String(istTime.getUTCDate()).padStart(2, '0');
    const hh = String(istTime.getUTCHours()).padStart(2, '0');
    const min = String(istTime.getUTCMinutes()).padStart(2, '0');
    const ss = String(istTime.getUTCSeconds()).padStart(2, '0');
    
    // Return in format: "2025-12-20 16:30:45"
    return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
}

// ✅ Get current time for display only (not for sending to server)
function getCurrentDisplayTime() {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    return `${hh}:${min}:${ss}`;
}

function login() {
    if (isLoggedIn) {
        alert("You are already logged in!");
        return;
    }
    
    getLocation((lat, lon, address) => {
        const dateTime = getCurrentIndianTimeString();  // ✅ Use Indian time
        const displayTime = getCurrentDisplayTime();    // ✅ For display only
        
        // Disable button during request
        const loginBtn = document.getElementById('loginBtn');
        loginBtn.disabled = true;
        loginBtn.innerHTML = 'Logging in...';
        
        document.getElementById('output').innerHTML =
            `<div class="badge login-badge"><b>Logging in...</b><br>Time: ${displayTime}<br>Location: ${address.substring(0, 50)}...</div>`;

        fetch('/training/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                lat: lat, 
                lon: lon, 
                address: address,
                dateTime: dateTime  // ✅ Send Indian time
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success'){
                isLoggedIn = true;
                updateButtons();
                
                document.getElementById('output').innerHTML =
                    `<div class="badge login-badge">
                        <b>✓ Login Successful</b><br>
                        <b>Time:</b> ${data.login_time}<br>
                        <b>Location:</b> ${data.address.substring(0, 50)}...
                    </div>`;
            } else {
                document.getElementById('output').innerHTML =
                    `<div class="badge error-badge"><b>Error:</b> ${data.error}</div>`;
                
                // Re-enable button
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Login';
            }
        })
        .catch(error => {
            document.getElementById('output').innerHTML =
                `<div class="badge error-badge"><b>Network Error:</b> ${error.message}</div>`;
            
            // Re-enable button
            loginBtn.disabled = false;
            loginBtn.innerHTML = 'Login';
        });
    });
}


// ... existing code ...

function logout() {
    if (!isLoggedIn) {
        alert("You are not logged in!");
        return;
    }
    
    getLocation((lat, lon, address) => {
        const dateTime = getCurrentIndianTimeString();
        const displayTime = getCurrentDisplayTime();
        
        // Disable button during request
        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn.disabled = true;
        logoutBtn.innerHTML = 'Logging out...';
        
        document.getElementById('output').innerHTML +=
            `<div class="badge logout-badge"><b>Logging out...</b><br>Time: ${displayTime}<br>Location: ${address.substring(0, 50)}...</div>`;

        fetch('/training/logout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                lat: lat, 
                lon: lon, 
                address: address,
                dateTime: dateTime
            })
        })
        .then(res => res.json())
        .then(data => {
            console.log("Logout response:", data);  // ✅ Debug
            
            if(data.status === 'success'){
                isLoggedIn = false;
                updateButtons();
                
                document.getElementById('output').innerHTML +=
                    `<div class="badge logout-badge">
                        <b>✓ Logout Successful</b><br>
                        <b>Logout Time:</b> ${data.logout_time}<br>
                        <b>Total Work Duration:</b> ${data.total_time}
                    </div>`;
            } else {
                document.getElementById('output').innerHTML +=
                    `<div class="badge error-badge"><b>Error:</b> ${data.error}</div>`;
                
                // Re-enable button
                logoutBtn.disabled = false;
                logoutBtn.innerHTML = 'Logout';
            }
        })
        .catch(error => {
            console.error("Logout error:", error);  // ✅ Debug
            document.getElementById('output').innerHTML +=
                `<div class="badge error-badge"><b>Network Error:</b> ${error.message}</div>`;
            
            // Re-enable button
            logoutBtn.disabled = false;
            logoutBtn.innerHTML = 'Logout';
        });
    });
}

// ... rest of the code ...

// Initialize buttons on page load
document.addEventListener('DOMContentLoaded', function() {
    updateButtons();
});

// CSRF token helper function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}